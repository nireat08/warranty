<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>ì œí’ˆ ë“±ë¡ ì‹œìŠ¤í…œ</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100;300;400;500;700;800;900&display=swap" rel="stylesheet">
<style>
  :root { --ci-blue: #2f6286; --ci-green: #72bf44; --ci-dark: #231f20; --ci-white: #ffffff; }
  body, html { margin: 0; padding: 0; font-family: 'Noto Sans KR', sans-serif; background-color: #f5f7fa; -webkit-user-select:none; user-select:none; }
  .inquiry-container { max-width: 600px; margin: 40px auto; padding: 30px; background-color: var(--ci-white); border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); position: relative; }
  .nav-header { display: flex; justify-content: flex-end; margin-bottom: 10px; }
  .home-btn { text-decoration: none; font-size: 13px; color: #888; font-weight: 500; display: flex; align-items: center; transition: color 0.3s; }
  .home-btn:hover { color: var(--ci-blue); }
  h2 { text-align: center; margin-bottom: 25px; color: var(--ci-dark); font-size: 24px; font-weight: 800; letter-spacing: -0.5px; }
  .required-mark { color: #e74c3c; margin-left: 3px; font-weight: bold; }
  .optional-mark { color: #888; font-weight: normal; font-size: 12px; margin-left: 5px; }
  .form-row { display: flex; gap: 15px; margin-bottom: 15px; }
  .form-row .form-group { flex: 1; margin-bottom: 0; position: relative; }
  .form-group { margin-bottom: 15px; position: relative; }
  .form-group label { display: block; margin-bottom: 6px; font-weight: 700; font-size: 13px; color: #555; }
  
  /* Input ìŠ¤íƒ€ì¼ */
  input[type="text"], select, input[type="file"] { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 15px; transition: border 0.3s; font-family: 'Noto Sans KR', sans-serif; }
  input:focus, select:focus { border-color: var(--ci-blue); outline: none; }
  
  .submit-btn { width: 100%; padding: 16px; background-color: var(--ci-blue); color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin-top: 15px; font-weight: 800; transition: background 0.3s; box-shadow: 0 4px 6px rgba(47, 98, 134, 0.2); }
  .submit-btn:disabled { background-color: #ccc; cursor: not-allowed; box-shadow: none; }
  
  /* ì•½ê´€ ë° ëª¨ë‹¬ */
  .agree-all-box { background-color: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid var(--ci-blue); display: flex; align-items: center; }
  .agree-all-label { font-size: 15px; font-weight: 800; color: var(--ci-blue); cursor: pointer; display: flex; align-items: center; width: 100%; }
  .agree-all-label input { width: 20px; height: 20px; margin-right: 10px; accent-color: var(--ci-blue); cursor: pointer; }
  .term-item { border: 1px solid #eee; border-radius: 8px; margin-bottom: 10px; background-color: #fff; display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; }
  .term-label { display: flex; align-items: center; font-size: 13px; font-weight: bold; color: var(--ci-dark); cursor: pointer; flex: 1; }
  .term-label input { width: 18px; height: 18px; margin-right: 10px; accent-color: var(--ci-blue); cursor: pointer; }
  .term-view-btn { font-size: 12px; color: #888; background: #f5f5f5; border: 1px solid #ddd; border-radius: 4px; padding: 4px 8px; cursor: pointer; margin-left: 10px; font-family: 'Noto Sans KR', sans-serif; }
  
  /* ëª¨ë‹¬ */
  .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; }
  .modal-box { background: white; width: 90%; max-width: 500px; max-height: 80vh; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 5px 30px rgba(0,0,0,0.3); }
  .modal-header { padding: 15px; background: #f0f4f8; border-bottom: 1px solid #eee; font-weight: bold; color: var(--ci-dark); display: flex; justify-content: space-between; align-items: center; }
  .modal-close { background: none; border: none; font-size: 20px; cursor: pointer; color: #666; }
  .modal-content { padding: 20px; overflow-y: auto; font-size: 13px; line-height: 1.6; color: #444; white-space: pre-wrap; font-family: 'Noto Sans KR', sans-serif; }
  .modal-footer { padding: 15px; border-top: 1px solid #eee; text-align: center; }
  .modal-btn { background: var(--ci-blue); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; font-family: 'Noto Sans KR', sans-serif; }
  
  /* ê¸°íƒ€ ìŠ¤íƒ€ì¼ */
  .serial-guide-box { background-color: #eef6fb; border: 1px solid #dbe2e8; border-radius: 6px; padding: 12px; margin-bottom: 10px; text-align: center; }
  .serial-guide-box img { max-width: 100%; border-radius: 4px; border: 1px solid #ccc; margin-bottom: 5px; }
  .serial-guide-text { font-size: 12px; color: var(--ci-blue); margin-top: 5px; font-weight: 500; }
  .error-msg { color: #e74c3c; font-size: 12px; margin-top: 5px; display: none; font-weight: bold; }
  .store-info-display { font-size: 13px; color: var(--ci-dark); background-color: #f2f2f2; padding: 12px; border-radius: 6px; margin-top: 5px; display: none; line-height: 1.6; border-left: 3px solid var(--ci-green); }
  .suggestions-list { position: absolute; top: 100%; left: 0; width: 100%; max-height: 200px; overflow-y: auto; background: #fff; border: 1px solid #ccc; border-radius: 0 0 6px 6px; z-index: 1000; list-style: none; padding: 0; margin: 0; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
  .suggestions-list li { padding: 12px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 14px; }
  .suggestions-list li:hover { background-color: #f0f8ff; color: var(--ci-blue); }
  .no-result-item { padding: 12px; color: #999; font-size: 13px; text-align: center; }
  #imgPreview { display: none; max-width: 100px; max-height: 100px; margin-top: 10px; border-radius: 6px; border: 1px solid #ddd; }
  
  /* ë¡œë”© */
  .loading-container { display: none; flex-direction: column; align-items: center; justify-content: center; margin-top: 15px; background-color: #f8f9fa; padding: 20px; border-radius: 8px; }
  .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--ci-blue); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin-bottom: 10px; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  .loading-msg { font-size: 14px; font-weight: bold; color: var(--ci-dark); text-align: center; }
  .wait-msg { font-size: 12px; color: #666; margin-top: 5px; text-align: center; }
  
  .footer-logo { text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px dashed #eee; }
  .footer-logo img { height: 24px; opacity: 0.8; }
  
  /* [ìˆ˜ì •] ì…ë ¥ì°½ + ì¡°íšŒë²„íŠ¼ (CI ì»¬ëŸ¬ ì ìš©) */
  .input-wrapper { position: relative; display: flex; gap: 8px; align-items: stretch; }
  .input-wrapper input { flex: 1; }
  .check-btn { 
    padding: 0 20px; 
    background-color: var(--ci-blue); /* íšŒìƒ‰ -> CI Blue ë³€ê²½ */
    color: white; 
    border: none; 
    border-radius: 6px; 
    cursor: pointer; 
    font-weight: 800; 
    font-size: 14px;
    white-space: nowrap;
    transition: background 0.2s;
    box-shadow: 0 3px 6px rgba(47, 98, 134, 0.2); /* ì€ì€í•œ ê·¸ë¦¼ì ì¶”ê°€ */
  }
  .check-btn:hover { background-color: #244d6b; /* í˜¸ë²„ ì‹œ ì•½ê°„ ì§„í•˜ê²Œ */ }

  /* 1ë‹¨ê³„ ë§í’ì„  */
  @keyframes attention-pulse { 0% { box-shadow: 0 0 0 0 rgba(47, 98, 134, 0.7); border-color: var(--ci-blue); } 70% { box-shadow: 0 0 0 10px rgba(47, 98, 134, 0); border-color: var(--ci-blue); } 100% { box-shadow: 0 0 0 0 rgba(47, 98, 134, 0); } }
  @keyframes float-badge { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
  .highlight-input { animation: attention-pulse 2s infinite; }
  .step-badge { position: absolute; bottom: 100%; right: 0; margin-bottom: 8px; background-color: var(--ci-blue); color: white; font-size: 11px; font-weight: bold; padding: 5px 10px; border-radius: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); animation: float-badge 1.5s ease-in-out infinite; z-index: 10; white-space: nowrap; }
  .step-badge::after { content: ''; position: absolute; top: 100%; right: 15px; border-width: 5px 5px 0; border-style: solid; border-color: var(--ci-blue) transparent transparent transparent; }
  
  @media (max-width: 500px) { .inquiry-container { margin: 15px; padding: 20px; } .form-row { flex-direction: column; gap: 0; } }
</style>
</head>
<body oncontextmenu="return false" ondragstart="return false" onselectstart="return false">
<div class="inquiry-container">
  <div class="nav-header"><a href="./main.html" class="home-btn">ğŸ  ë©”ì¸ìœ¼ë¡œ</a></div>
  <h2>ì œí’ˆ ë“±ë¡ ë° ë³´ì¦ ì—°ì¥</h2>
  
  <form id="registForm">
    <div class="agree-all-box">
      <label class="agree-all-label"><input type="checkbox" id="allAgree"> ì•½ê´€ ì „ì²´ ë™ì˜í•˜ê¸°</label>
    </div>

    <div class="term-item"><label class="term-label"><input type="checkbox" id="privacyAgree" class="agree-item"> ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš© ë™ì˜ <span class="required-mark">(í•„ìˆ˜)</span></label><button type="button" class="term-view-btn" onclick="openModal('modalPrivacy')">ë‚´ìš©ë³´ê¸°</button></div>
    <div class="term-item"><label class="term-label"><input type="checkbox" id="thirdPartyAgree" class="agree-item"> ê°œì¸ì •ë³´ ì œ3ì ì œê³µ ë™ì˜ <span class="required-mark">(í•„ìˆ˜)</span></label><button type="button" class="term-view-btn" onclick="openModal('modalThird')">ë‚´ìš©ë³´ê¸°</button></div>
    <div class="term-item"><label class="term-label"><input type="checkbox" id="marketingAgree" class="agree-item"> ë§ˆì¼€íŒ… ì •ë³´ ìˆ˜ì‹  ë™ì˜ <span class="optional-mark">(ì„ íƒ)</span></label><button type="button" class="term-view-btn" onclick="openModal('modalMarketing')">ë‚´ìš©ë³´ê¸°</button></div>

    <div class="form-group" style="margin-top:20px;">
      <label for="serialNo">ì œí’ˆ ë²ˆí˜¸ (ì°¨ëŒ€ë²ˆí˜¸) <span class="required-mark">*</span></label>
      <div class="serial-guide-box"><img src="https://placehold.co/400x150/png?text=Serial+Number+Location" alt="ì°¨ëŒ€ë²ˆí˜¸ ì˜ˆì‹œ"><div class="serial-guide-text">ğŸ’¡ í”„ë ˆì„ í•˜ë‹¨, í˜¹ì€ ë°°í„°ë¦¬ ì•ˆìª½ ë¼ë²¨ì„ í™•ì¸í•´ì£¼ì„¸ìš”.</div></div>
      
      <div class="input-wrapper">
        <div id="stepBadge" class="step-badge">ğŸ‘ˆ 1ë‹¨ê³„: ë¨¼ì € ì¡°íšŒí•´ì£¼ì„¸ìš”!</div>
        <input type="text" id="serialNo" class="highlight-input" placeholder="ì‹œë¦¬ì–¼ ë²ˆí˜¸ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”" autocomplete="off">
        <button type="button" id="btnCheckSerial" class="check-btn">ì¡°íšŒ</button>
      </div>
      <p id="serialError" class="error-msg">ì˜¬ë°”ë¥¸ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.</p>
    </div>

    <div class="form-row">
      <div class="form-group"><label for="userName">ì´ë¦„ <span class="required-mark">*</span></label><input type="text" id="userName" placeholder="ì„±í•¨ ì…ë ¥" autocomplete="off"></div>
      <div class="form-group"><label for="userPhone">ì „í™”ë²ˆí˜¸ <span class="required-mark">*</span></label><input type="text" id="userPhone" placeholder="010-0000-0000" maxlength="13" autocomplete="off"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label for="productSelect">êµ¬ì… ì œí’ˆ ëª¨ë¸ <span class="required-mark">*</span></label><select id="productSelect"><option value="">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</option></select></div>
      <div class="form-group">
        <label for="storeInput">êµ¬ì… ë§¤ì¥ (ê²€ìƒ‰) <span class="required-mark">*</span></label>
        <input type="text" id="storeInput" placeholder="ë§¤ì¥ëª…, ëŒ€ë¦¬ì ëª…, ì£¼ì†Œ ê²€ìƒ‰" autocomplete="off">
        <input type="hidden" id="storeCode"><ul id="suggestions" class="suggestions-list"></ul><div id="storeInfoDisplay" class="store-info-display"></div>
      </div>
    </div>
    <div class="form-group">
      <label for="receiptFile">êµ¬ë§¤ ì˜ìˆ˜ì¦ ì²¨ë¶€ (ì´ë¯¸ì§€) <span class="required-mark">*</span></label>
      <input type="file" id="receiptFile" accept="image/jpeg,image/png,application/pdf">
      <img id="imgPreview">
      <div style="font-size:11px; color:#e74c3c; margin-top:5px; font-weight:bold;">* 3MB ì´í•˜ì˜ JPG, PNG, PDF íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>
    </div>

    <button type="button" class="submit-btn" onclick="submitForm()">ë“±ë¡ ì‹ ì²­í•˜ê¸°</button>
    <div id="loadingArea" class="loading-container"><div class="spinner"></div><div id="loadingText" class="loading-msg">ì‚¬ì§„ ì—…ë¡œë“œ ë° ë“±ë¡ ì¤‘ì…ë‹ˆë‹¤...</div><div id="waitText" class="wait-msg">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</div></div>
  </form>
  <div class="footer-logo"><img src="https://via.placeholder.com/150x40/231f20/ffffff?text=QUALI+SPORTS" alt="QUALI SPORTS"></div>
</div>

<div id="modalPrivacy" class="modal-overlay" onclick="closeModal('modalPrivacy')"><div class="modal-box" onclick="event.stopPropagation()"><div class="modal-header">ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš© ë™ì˜ <button class="modal-close" onclick="closeModal('modalPrivacy')">&times;</button></div><div class="modal-content">1. ìˆ˜ì§‘ í•­ëª©: ì´ë¦„, ì—°ë½ì²˜, ì œí’ˆ ì •ë³´(ëª¨ë¸ëª…, ì°¨ëŒ€ë²ˆí˜¸), êµ¬ë§¤ ë§¤ì¥ ì •ë³´, ì˜ìˆ˜ì¦ ì´ë¯¸ì§€<br><br>2. ìˆ˜ì§‘ ëª©ì : ì •í’ˆ ë“±ë¡ í™•ì¸, ë³´ì¦ ê¸°ê°„ ì—°ì¥, AS ì ‘ìˆ˜ ì‹œ ê³ ê° ì‹ë³„ ë° ì´ë ¥ ê´€ë¦¬<br><br>3. ë³´ìœ  ê¸°ê°„: ì œí’ˆ ë³´ì¦ ê¸°ê°„ ë§Œë£Œ í›„ 1ë…„ê¹Œì§€ (ë‹¨, ë²•ë ¹ì— íŠ¹ë³„í•œ ê·œì •ì´ ìˆëŠ” ê²½ìš° ê´€ë ¨ ë²•ë ¹ì— ë”°ë¦„)<br><br>4. ë™ì˜ ê±°ë¶€ ê¶Œë¦¬: ë³¸ ë™ì˜ë¥¼ ê±°ë¶€í•  ìˆ˜ ìˆìœ¼ë‚˜, ë¯¸ë™ì˜ ì‹œ ì •í’ˆ ë“±ë¡ ë° ë³´ì¦ ì—°ì¥ í˜œíƒì„ ë°›ìœ¼ì‹¤ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div><div class="modal-footer"><button class="modal-btn" onclick="closeModal('modalPrivacy')">í™•ì¸</button></div></div></div>
<div id="modalThird" class="modal-overlay" onclick="closeModal('modalThird')"><div class="modal-box" onclick="event.stopPropagation()"><div class="modal-header">ê°œì¸ì •ë³´ ì œ3ì ì œê³µ ë™ì˜ <button class="modal-close" onclick="closeModal('modalThird')">&times;</button></div><div class="modal-content">1. ì œê³µë°›ëŠ” ì: êµ¬ë§¤í•˜ì‹  ëŒ€ë¦¬ì  ë° í€„ë¦¬ìŠ¤í¬ì¸  í˜‘ë ¥ AS ì§€ì •ì <br><br>2. ì œê³µ ëª©ì : ì œí’ˆ ìˆ˜ë¦¬ ë° ì ê²€, ë¶€í’ˆ êµì²´ ë“± ì›í™œí•œ AS ì„œë¹„ìŠ¤ ì œê³µ<br><br>3. ì œê³µ í•­ëª©: ì´ë¦„, ì—°ë½ì²˜, ì°¨ëŒ€ë²ˆí˜¸, ì°¨ì¢…<br><br>4. ë³´ìœ  ê¸°ê°„: ì„œë¹„ìŠ¤ ì œê³µ ëª©ì  ë‹¬ì„± ì‹œê¹Œì§€</div><div class="modal-footer"><button class="modal-btn" onclick="closeModal('modalThird')">í™•ì¸</button></div></div></div>
<div id="modalMarketing" class="modal-overlay" onclick="closeModal('modalMarketing')"><div class="modal-box" onclick="event.stopPropagation()"><div class="modal-header">ë§ˆì¼€íŒ… ì •ë³´ ìˆ˜ì‹  ë™ì˜ <button class="modal-close" onclick="closeModal('modalMarketing')">&times;</button></div><div class="modal-content">1. ì‹ ì œí’ˆ ì¶œì‹œ ì†Œì‹, í• ì¸ í”„ë¡œëª¨ì…˜, ì´ë²¤íŠ¸ í˜œíƒ ë“± ë‹¤ì–‘í•œ ì •ë³´ë¥¼ SMS, ì•Œë¦¼í†¡ ë“±ìœ¼ë¡œ ë°›ì•„ë³´ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br><br>2. ë™ì˜í•˜ì§€ ì•Šìœ¼ì…”ë„ ì •í’ˆ ë“±ë¡ ì„œë¹„ìŠ¤ ì´ìš©ì—ëŠ” ì œí•œì´ ì—†ìŠµë‹ˆë‹¤.</div><div class="modal-footer"><button class="modal-btn" onclick="closeModal('modalMarketing')">í™•ì¸</button></div></div></div>

<div id="systemAlert" class="modal-overlay">
  <div class="modal-box" style="max-width: 350px; text-align: center;">
    <div class="modal-header" style="justify-content: center;">ì•Œë¦¼</div>
    <div class="modal-content" style="padding: 30px 20px; font-size: 15px; word-break: keep-all;"><span id="systemAlertMsg"></span></div>
    <div class="modal-footer" style="justify-content: center;"><button class="modal-btn" id="systemAlertBtn">í™•ì¸</button></div>
  </div>
</div>

<script>
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyy02EOo87dG4BWco1kbLO3O9BXwFSUKy-olHVwUim_E_07Azl5tl-e40UO1uBqoyeJ/exec"; 
  const MAX_FILE_SIZE = 3 * 1024 * 1024;
  let ALL_STORES = [], STORE_DATA_MAP = {}; 
  let GLOBAL_RETRY_COUNT = 0;

  function openModal(id) { const el = document.getElementById(id); if(el) el.style.display = 'flex'; }
  function closeModal(id) { const el = document.getElementById(id); if(el) el.style.display = 'none'; }

  function showAlert(message, callback) {
    const modal = document.getElementById('systemAlert');
    const msgBox = document.getElementById('systemAlertMsg');
    const btn = document.getElementById('systemAlertBtn');
    if (modal && msgBox && btn) {
      msgBox.innerHTML = message.replace(/\n/g, "<br>");
      modal.style.display = 'flex';
      btn.onclick = function() { modal.style.display = 'none'; if (callback) callback(); };
    } else { alert(message); if (callback) callback(); }
  }

  const allAgree = document.getElementById("allAgree");
  const agreeItems = document.querySelectorAll(".agree-item");
  allAgree.addEventListener("change", function() { agreeItems.forEach(item => item.checked = allAgree.checked); });
  agreeItems.forEach(item => { item.addEventListener("change", function() { const allChecked = Array.from(agreeItems).every(i => i.checked); allAgree.checked = allChecked; }); });

  window.addEventListener("pageshow", function(event) {
    if (event.persisted || (window.performance && window.performance.navigation.type === 2)) {
      document.getElementById("registForm").reset();
      document.getElementById("storeInfoDisplay").style.display = "none";
      document.getElementById("serialError").style.display = "none";
      document.getElementById("imgPreview").style.display = "none";
      setButtonState(true);
      document.getElementById("loadingArea").style.display = "none";
      document.getElementById("serialNo").classList.add("highlight-input");
      document.getElementById("stepBadge").style.display = "block";
    }
  });

  document.addEventListener("DOMContentLoaded", function() {
    fetchWithRetry(WEB_APP_URL, {}, 3).then(data => { 
        const productSelect = document.getElementById("productSelect");
        updateSelectOptions(productSelect, data.products, "ì œí’ˆ ëª¨ë¸ ì„ íƒ");
        ALL_STORES = data.stores; STORE_DATA_MAP = {}; 
        data.stores.forEach(store => { STORE_DATA_MAP[store.name] = store; });
        document.getElementById("storeInput").placeholder = "ë§¤ì¥ëª…, ëŒ€ë¦¬ì ëª…, ì£¼ì†Œ ê²€ìƒ‰";
      }).catch(err => console.error("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨")); 
  });

  const receiptFile = document.getElementById("receiptFile");
  const previewImg = document.getElementById("imgPreview");
  receiptFile.addEventListener("change", function() {
    if (this.files.length > 0) {
      if(this.files[0].size > MAX_FILE_SIZE) { 
        showAlert("âŒ íŒŒì¼ ìš©ëŸ‰ì´ 3MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤!\nìš©ëŸ‰ì„ ì¤„ì—¬ì„œ ë‹¤ì‹œ ì˜¬ë ¤ì£¼ì„¸ìš”."); 
        this.value = ""; previewImg.style.display = "none"; return; 
      }
      const reader = new FileReader();
      reader.onload = function(e) { previewImg.src = e.target.result; previewImg.style.display = "block"; }
      reader.readAsDataURL(this.files[0]);
    } else { previewImg.style.display = "none"; }
  });

  const storeInput = document.getElementById("storeInput");
  const storeCodeInput = document.getElementById("storeCode");
  const suggestions = document.getElementById("suggestions");
  const infoDisplay = document.getElementById("storeInfoDisplay");
  storeInput.addEventListener("input", function() {
    const keyword = this.value.toLowerCase().trim();
    suggestions.innerHTML = ""; infoDisplay.style.display = "none"; 
    if (keyword.length === 0) { suggestions.style.display = "none"; return; }
    const matched = ALL_STORES.filter(store => {
      return store.name.toLowerCase().includes(keyword) || (store.alias && store.alias.toLowerCase().includes(keyword)) || (store.addr && store.addr.toLowerCase().includes(keyword)) || (store.agency && store.agency.toLowerCase().includes(keyword));
    });
    if (matched.length > 0) {
      suggestions.style.display = "block";
      matched.forEach(store => {
        const li = document.createElement("li"); li.innerText = store.agency ? `${store.name} (${store.agency})` : store.name; 
        li.addEventListener("click", function() { selectStore(store); }); suggestions.appendChild(li);
      });
    } else { suggestions.style.display = "block"; const li = document.createElement("li"); li.innerText = "ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤."; li.className = "no-result-item"; suggestions.appendChild(li); }
  });
  function selectStore(storeObj) {
    storeInput.value = storeObj.name; storeCodeInput.value = storeObj.code; suggestions.style.display = "none"; 
    infoDisplay.style.display = "block"; infoDisplay.innerHTML = `ğŸ“ <b>ì£¼ì†Œ:</b> ${storeObj.addr || "ì—†ìŒ"}<br>ğŸ“ <b>ì—°ë½ì²˜:</b> ${storeObj.phone || "ì—†ìŒ"}`; storeInput.style.border = "1px solid #ccc";
  }
  document.addEventListener("click", function(e) { if (!storeInput.contains(e.target) && !suggestions.contains(e.target)) suggestions.style.display = "none"; });

  const phoneInput = document.getElementById("userPhone");
  phoneInput.addEventListener('input', function(e) {
    let val = e.target.value.replace(/[^0-9]/g, '');
    if (val.length > 3 && val.length <= 7) val = val.slice(0, 3) + "-" + val.slice(3); else if (val.length > 7) val = val.slice(0, 3) + "-" + val.slice(3, 7) + "-" + val.slice(7);
    e.target.value = val.slice(0, 13);
  });

  const serialInput = document.getElementById("serialNo");
  const serialError = document.getElementById("serialError");
  const stepBadge = document.getElementById("stepBadge");
  const btnCheckSerial = document.getElementById("btnCheckSerial");

  // ì‹¤ì œ ì¡°íšŒ í•¨ìˆ˜
  function runSerialCheck() {
    const val = serialInput.value.trim(); 
    if (val.length < 1) {
      serialError.style.display = "none"; serialError.innerText = ""; setButtonState(true);
      serialInput.classList.add("highlight-input"); if(stepBadge) stepBadge.style.display = "block";
      const select = document.getElementById("productSelect"); if(select) select.value = ""; 
      return; 
    }
    serialError.style.display = "block"; serialError.style.color = "var(--ci-blue)"; serialError.innerText = "í™•ì¸ ì¤‘..."; setButtonState(false);
    fetchWithRetry(WEB_APP_URL + "?type=check&no=" + val, {}, 2).then(d => {
        if (d.status === "ok") { 
          serialError.style.color = "var(--ci-green)"; serialError.innerText = `âœ… í™•ì¸ë¨ (${d.model})`; setButtonState(true); 
          const select = document.getElementById("productSelect"); if(d.model) select.value = d.model; 
        } 
        else { serialError.style.color = "#e74c3c"; serialError.innerText = "âŒ " + d.message; setButtonState(false); }
    }).catch(e => { serialError.innerText = ""; setButtonState(true); });
  }

  // ì´ë²¤íŠ¸ ì—°ê²°
  if(btnCheckSerial) btnCheckSerial.addEventListener("click", runSerialCheck);
  serialInput.addEventListener("blur", runSerialCheck);
  serialInput.addEventListener("focus", function() { this.classList.remove("highlight-input"); if(stepBadge) stepBadge.style.display = "none"; });
  serialInput.addEventListener("keypress", function(e) { if(e.key === 'Enter') { e.preventDefault(); runSerialCheck(); } });

  function updateSelectOptions(el, items, defText) { 
    el.innerHTML = ""; const opt = document.createElement("option"); opt.value = ""; opt.text = defText; opt.disabled = true; opt.selected = true; opt.hidden = true; el.add(opt); 
    if(items) { items.forEach(i => { const o = document.createElement("option"); o.value = i; o.text = i; el.add(o); }); }
  }
  function setButtonState(e) { const submitBtn = document.querySelector(".submit-btn"); submitBtn.disabled = !e; submitBtn.style.backgroundColor = e ? "var(--ci-blue)" : "#ccc"; }

  async function fetchWithRetry(url, options = {}, retries = 3, backoff = 1000) {
    try {
      const response = await fetch(url, options);
      if (!response.ok) throw new Error("Server Busy");
      return await response.json();
    } catch (error) {
      if (retries > 0) {
        GLOBAL_RETRY_COUNT++;
        const waitText = document.getElementById("waitText");
        if(waitText) waitText.innerText = `ì ‘ì†ëŸ‰ì´ ë§ì•„ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤... (${GLOBAL_RETRY_COUNT}íšŒ ì¬ì‹œë„)`;
        await new Promise(resolve => setTimeout(resolve, backoff));
        return fetchWithRetry(url, options, retries - 1, backoff * 2);
      } else { throw error; }
    }
  }

  function submitForm() {
    const userName = document.getElementById("userName").value;
    const userPhone = document.getElementById("userPhone").value;
    const product = document.getElementById("productSelect").value;
    const storeName = document.getElementById("storeInput").value;
    const storeCode = document.getElementById("storeCode").value; 
    const serialNo = document.getElementById("serialNo").value;
    const privacyAgree = document.getElementById("privacyAgree").checked;
    const thirdPartyAgree = document.getElementById("thirdPartyAgree").checked;
    const marketingAgree = document.getElementById("marketingAgree").checked;
    const fileInput = document.getElementById("receiptFile");

    if (!privacyAgree) return showAlert("ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš©ì— ë™ì˜í•´ì•¼ í•©ë‹ˆë‹¤. (í•„ìˆ˜)");
    if (!thirdPartyAgree) return showAlert("ê°œì¸ì •ë³´ ì œ3ì ì œê³µì— ë™ì˜í•´ì•¼ í•©ë‹ˆë‹¤. (í•„ìˆ˜)");
    if (!serialNo) return showAlert("ì œí’ˆ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ê³  í™•ì¸ë°›ìœ¼ì„¸ìš”.");
    if (!userName) return showAlert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    if (!userPhone) return showAlert("ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    if (!product) return showAlert("ì œí’ˆ ëª¨ë¸ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
    if (!storeName || !storeCode) return showAlert("êµ¬ì… ë§¤ì¥ì„ ëª©ë¡ì—ì„œ ì •í™•íˆ ì„ íƒí•´ì£¼ì„¸ìš”.");
    if (fileInput.files.length === 0) return showAlert("êµ¬ë§¤ ì˜ìˆ˜ì¦ì€ í•„ìˆ˜ í•­ëª©ì…ë‹ˆë‹¤.");
    if (fileInput.files[0].size > MAX_FILE_SIZE) return showAlert("íŒŒì¼ ìš©ëŸ‰ì´ 3MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.");

    setButtonState(false); document.getElementById("loadingArea").style.display = "flex"; document.getElementById("waitText").innerText = "ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”."; GLOBAL_RETRY_COUNT = 0; 

    const formData = { userName, userPhone, product, storeName, storeCode, serialNo, marketingConsent: marketingAgree };
    const file = fileInput.files[0];
    const reader = new FileReader();
    reader.onload = function(e) {
      formData.fileName = file.name; formData.mimeType = file.type; formData.fileData = e.target.result.split(",")[1];
      fetchWithRetry(WEB_APP_URL, { method: "POST", headers: { "Content-Type": "text/plain;charset=utf-8" }, body: JSON.stringify(formData) }, 5, 1000) 
      .then(res => {
        if (res.result === "success") {
          showAlert("âœ… ì œí’ˆ ë“±ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\në“±ë¡ ë‚´ì—­ í™•ì¸ í˜ì´ì§€ë¡œ ìë™ ì´ë™í•©ë‹ˆë‹¤.", function() {
            window.location.href = "./product_check.html?name=" + encodeURIComponent(formData.userName) + "&phone=" + encodeURIComponent(formData.userPhone);
          });
        } else if (res.message.includes("ì´ë¯¸ ë“±ë¡ëœ ì œí’ˆ") && GLOBAL_RETRY_COUNT > 0) {
           showAlert("âœ… (ì¬ì ‘ì† ì„±ê³µ) ì œí’ˆ ë“±ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\në“±ë¡ ë‚´ì—­ í™•ì¸ í˜ì´ì§€ë¡œ ìë™ ì´ë™í•©ë‹ˆë‹¤.", function() {
              window.location.href = "./product_check.html?name=" + encodeURIComponent(formData.userName) + "&phone=" + encodeURIComponent(formData.userPhone);
           });
        } else { 
          showAlert("ì˜¤ë¥˜ ë°œìƒ: " + res.message); setButtonState(true); document.getElementById("loadingArea").style.display = "none"; 
        }
      }).catch(e => { 
        showAlert("ì ‘ì†ìê°€ ë§ì•„ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\nì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."); setButtonState(true); document.getElementById("loadingArea").style.display = "none"; 
      });
    };
    reader.readAsDataURL(file);
  }
  document.addEventListener('keydown', function(e) { if (e.keyCode === 123 || (e.ctrlKey && e.shiftKey && e.keyCode === 73) || (e.ctrlKey && e.keyCode === 85)) { e.preventDefault(); return false; } });
</script>
</body>
</html>